{% extends "base.html" %}

{% block title %}Golf Pick 'Em - Season Standings{% endblock %}

{% block content %}
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <h2>Season Standings</h2>
        <p class="text-muted">
            {{ completed_tournaments }} of {{ total_tournaments }} tournaments complete
        </p>

        {# Coming Up Banner - shown when featuring completed tournament but next one is known #}
        {% if upcoming_tournament %}
        <div class="alert alert-primary d-flex justify-content-between align-items-center">
            <div>
                <strong>ğŸ—“ï¸ Coming Up:</strong>
                <a href="{{ url_for('tournament_detail', tournament_id=upcoming_tournament.id) }}" class="alert-link">
                    {{ upcoming_tournament.name }}
                </a>
                <br><small>{{ upcoming_tournament.start_date.strftime('%B %d') }} - {{ upcoming_tournament.end_date.strftime('%B %d') }} Â· Field not yet available</small>
            </div>
            <span class="badge bg-primary">{{ upcoming_tournament.get_deadline_display() }}</span>
        </div>
        {% endif %}

        {# Featured Tournament Info #}
        {% if featured_tournament %}
        <div class="alert {% if featured_tournament.status == 'active' %}alert-info{% elif featured_tournament.status == 'complete' %}alert-secondary{% else %}alert-success{% endif %}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    {% if featured_tournament.status == 'active' %}
                        <strong>ğŸŒï¸ In Progress:</strong>
                    {% elif featured_tournament.status == 'complete' %}
                        <strong>ğŸ† Latest Results:</strong>
                    {% elif current_user.is_authenticated and user_pick %}
                        <strong>âœï¸ Edit Pick:</strong>
                    {% else %}
                        <strong>ğŸ“‹ Make Your Picks:</strong>
                    {% endif %}
                    {% if featured_tournament.is_major %}
                        <span class="badge bg-warning text-dark ms-2">â­ 1.5x Major</span>
                    {% endif %}
                    <a href="{{ url_for('tournament_detail', tournament_id=featured_tournament.id) }}" class="alert-link">
                        {{ featured_tournament.name }}
                    </a>
                    {% if featured_tournament.status == 'active' %}
                        <br><small>ğŸ’¡ Earnings shown are projections. Final results updated Monday.</small>
                    {% elif featured_tournament.status == 'upcoming' and not featured_tournament.is_deadline_passed() %}
                        <br><small>â° Deadline: {{ featured_tournament.get_deadline_display() }}</small>
                    {% endif %}
                </div>
                {% if featured_tournament.status == 'complete' %}
                    <a href="{{ url_for('tournament_detail', tournament_id=featured_tournament.id) }}" class="btn btn-sm btn-outline-secondary">
                        View Full Results â†’
                    </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <table class="table table-striped table-hover">
            <thead class="table-success">
                <tr>
                    <th>Rank</th>
                    <th>Player</th>
                    <th class="text-end">Total Points</th>
                    {% if featured_tournament and show_picks %}
                    <th>{{ featured_tournament.name }} Pick</th>
                    <th class="text-end">
                        {% if featured_tournament.status == 'complete' %}Earned{% else %}Projected{% endif %}
                    </th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr {% if current_user.is_authenticated and user.id == current_user.id %}class="table-warning"{% endif %}>
                    <td>
                        <strong>{{ loop.index }}</strong>
                        {% if loop.index == 1 %}ğŸ†{% elif loop.index == 2 %}ğŸ¥ˆ{% elif loop.index == 3 %}ğŸ¥‰{% endif %}
                    </td>
                    <td>
                        <strong>{{ user.get_display_name() }}</strong>
                        {% if not user.has_paid %}
                            <span class="badge bg-secondary">Unpaid</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <span class="badge bg-success fs-6">${{ "{:,}".format(user.total_points) }}</span>
                    </td>
                    {% if featured_tournament and show_picks %}
                    <td>
                        {% if user.id in tournament_picks %}
                            {{ tournament_picks[user.id].primary }}
                            {% if tournament_picks[user.id].admin_override %}
                                <span class="badge bg-warning text-dark" title="{{ tournament_picks[user.id].admin_override_note or 'Admin override pick' }}">ğŸ‘‘</span>
                            {% endif %}
                            {% if tournament_picks[user.id].backup_activated %}
                                <span class="badge bg-info" title="Backup activated">ğŸ”„</span>
                            {% endif %}
                            {% if tournament_picks[user.id].position %}
                                <br><small class="text-muted">{{ tournament_picks[user.id].position }}</small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">No Pick</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        {% if user.id in tournament_picks %}
                            <span class="badge bg-{% if featured_tournament.status == 'complete' %}success{% else %}warning text-dark{% endif %}">
                                ${{ "{:,}".format(tournament_picks[user.id].earnings) }}
                            </span>
                        {% else %}
                            <span class="text-muted">$0</span>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr>
                    <td colspan="{{ 5 if featured_tournament and show_picks else 3 }}" class="text-center text-muted">
                        No players yet. Be the first to register!
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Pick Status - show if upcoming tournament with field -->
        {% if current_user.is_authenticated and featured_tournament and featured_tournament.status != 'complete' and not featured_tournament.is_deadline_passed() %}
        <div class="card mb-3 border-success">
            <div class="card-body">
                {% if user_pick %}
                    <!-- User has a pick -->
                    <h5 class="text-success text-center">âœ… Pick Submitted!</h5>
                    <hr>
                    <p class="mb-1"><strong>Primary:</strong> {{ user_pick.primary_player.full_name() }}</p>
                    <p class="mb-2"><strong>Backup:</strong> {{ user_pick.backup_player.full_name() }}</p>
                    <p class="text-muted small mb-3">Deadline: {{ featured_tournament.get_deadline_display() }}</p>
                    <div class="text-center">
                        <a href="{{ url_for('make_pick', tournament_id=featured_tournament.id) }}"
                            class="btn btn-outline-primary btn-sm fw-semibold">
                            âœï¸ Edit Pick
                        </a>
                    </div>
                {% else %}
                    <!-- User needs to make a pick -->
                    <h5 class="text-center">â° Make Your Pick!</h5>
                    <p class="mb-2 text-center">Deadline: {{ featured_tournament.get_deadline_display() }}</p>
                    <div class="text-center">
                        <a href="{{ url_for('make_pick', tournament_id=featured_tournament.id) }}" class="btn btn-success btn-lg">
                            Pick for {{ featured_tournament.name }}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- League Rules -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">ğŸ“‹ League Rules</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Pick <strong>one golfer</strong> per tournament (primary + backup)</li>
                    <li>Points = <strong>actual prize money</strong> earned</li>
                    <li>Each golfer can only be used <strong>once per season</strong></li>
                    <li>Backup activates only if primary WDs before completing Round 2</li>
                    <li><strong>â­ Majors pay 1.5x</strong> (Masters, PGA, US Open, The Open)</li>
                    <li>Highest total points at season end wins!</li>
                </ul>
            </div>
        </div>

        <!-- Prize Pool -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ’° Prize Pool</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">
                    $25 entry fee Ã— {{ users|length }} players =
                    <strong>${{ 25 * users|length }}</strong> pot
                </p>
                <p class="text-muted mb-0"><small>Venmo: @Bradley-Hagstrom or Zelle/AP: 630-408-3424</small></p>
            </div>
        </div>

        <!-- Season Progress -->
        <div class="card mt-3">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">ğŸ“Š Season Progress</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         style="width: {{ (completed_tournaments / total_tournaments * 100) if total_tournaments > 0 else 0 }}%">
                        {{ completed_tournaments }} / {{ total_tournaments }}
                    </div>
                </div>
                <p class="text-muted mb-0 small">Tournaments Completed</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
